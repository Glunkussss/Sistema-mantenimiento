let generalChart,technicianChart,incidentChart,locationChart,inventoryChart;async function initReports(){try{await loadTechnicians();await loadGeneralReport();await loadTechnicianReport();await loadIncidentTypes();await loadDetailedTable();await loadLocationReport();await loadInventoryReport();}catch(error){console.error('Error inicializando reportes:',error);ToastManager.error('Error al cargar reportes');}}
async function loadTechnicians(){try{const users=await HttpClient.get('/usuarios');const select=document.getElementById('tecnicoSelect');select.innerHTML='<option value="">Todos los técnicos</option>';users.filter(u=>u.cargo==='tecnico').forEach(user=>{select.innerHTML+=`<option value="${user.id}">${user.nombre_completo}</option>`;});}catch(error){console.error('Error cargando técnicos:',error);}}
async function loadGeneralReport(){try{const data=await HttpClient.get('/reporte/general');document.getElementById('totalTareas').textContent=data.total_tareas||'0';document.getElementById('completadas').textContent=data.completadas||'0';document.getElementById('pendientes').textContent=data.pendientes||'0';const efficiency=data.total_tareas>0?(data.completadas/data.total_tareas*100).toFixed(1):0;const statsContainer=document.getElementById('generalStats');if(statsContainer.children.length<4){statsContainer.innerHTML+=`<div class="chart-stat"><p class="chart-stat-value">${efficiency}%</p><p class="chart-stat-label">Eficiencia</p></div><div class="chart-stat"><p class="chart-stat-value">${data.tecnicos_activos||0}</p><p class="chart-stat-label">Técnicos Activos</p></div><div class="chart-stat"><p class="chart-stat-value">${data.promedio_dias_resolucion||0}</p><p class="chart-stat-label">Días Prom. Resolución</p></div>`;}
if(generalChart)generalChart.destroy();const ctx=document.getElementById('generalChart').getContext('2d');generalChart=new Chart(ctx,{type:'doughnut',data:{labels:['Completadas','Pendientes','En Progreso'],datasets:[{data:[data.completadas||0,data.pendientes||0,data.en_progreso||0],backgroundColor:['#10b981','#f59e0b','#2563eb'],borderWidth:2,borderColor:'#ffffff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{usePointStyle:true,padding:20}}}}});}catch(error){console.error('Error cargando reporte general:',error);document.getElementById('generalChart').getContext('2d').fillText('Error al cargar datos',100,100);}}
async function loadTechnicianReport(){try{const selectedTecnico=document.getElementById('tecnicoSelect').value;if(!selectedTecnico){await loadAllTechniciansChart();return;}
const data=await HttpClient.get(`/reporte/tecnico/${selectedTecnico}`);if(technicianChart)technicianChart.destroy();const ctx=document.getElementById('technicianChart').getContext('2d');technicianChart=new Chart(ctx,{type:'bar',data:{labels:['Completadas','Pendientes'],datasets:[{label:data.tecnico,data:[data.completadas||0,data.pendientes||0],backgroundColor:['#10b981','#f59e0b'],borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});}catch(error){console.error('Error cargando reporte técnico:',error);}}
async function loadAllTechniciansChart(){try{const users=await HttpClient.get('/usuarios');const technicians=users.filter(u=>u.cargo==='tecnico');const data=[];const labels=[];for(const tech of technicians){try{const report=await HttpClient.get(`/reporte/tecnico/${tech.id}`);labels.push(tech.nombre_completo.split(' ')[0]);data.push(report.completadas||0);}catch(e){labels.push(tech.nombre_completo.split(' ')[0]);data.push(0);}}
if(technicianChart)technicianChart.destroy();const ctx=document.getElementById('technicianChart').getContext('2d');technicianChart=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Tareas Completadas',data:data,backgroundColor:'#2563eb',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});}catch(error){console.error('Error cargando datos de todos los técnicos:',error);}}
async function loadIncidentTypes(){try{const data=await HttpClient.get('/reporte/tipo-incidencia');if(!data||data.length===0){const ctx=document.getElementById('incidentChart').getContext('2d');ctx.fillStyle='#64748b';ctx.font='16px Arial';ctx.textAlign='center';ctx.fillText('No hay datos disponibles',ctx.canvas.width/2,ctx.canvas.height/2);return;}
const labels=data.map(item=>item.tipo_incidencia);const values=data.map(item=>item.cantidad);const colors=['#2563eb','#10b981','#f59e0b','#ef4444','#8b5cf6','#06b6d4','#84cc16','#f97316'];if(incidentChart)incidentChart.destroy();const ctx=document.getElementById('incidentChart').getContext('2d');incidentChart=new Chart(ctx,{type:'pie',data:{labels:labels,datasets:[{data:values,backgroundColor:colors.slice(0,labels.length),borderWidth:2,borderColor:'#ffffff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{usePointStyle:true,padding:15}}}}});}catch(error){console.error('Error cargando tipos de incidencia:',error);}}
async function loadDetailedTable(){try{const users=await HttpClient.get('/usuarios');const technicians=users.filter(u=>u.cargo==='tecnico');const tbody=document.getElementById('technicianTable');let html='';for(const tech of technicians){try{const report=await HttpClient.get(`/reporte/tecnico/${tech.id}`);const efficiency=report.total_tareas>0?(report.completadas/report.total_tareas*100).toFixed(1):0;const promedio=report.promedio_dias||'N/A';html+=`<tr><td><div class="user-info"><strong>${tech.nombre_completo}</strong><small>${tech.correo}</small></div></td><td>${report.total_tareas||0}</td><td>${report.completadas||0}</td><td>${report.pendientes||0}</td><td><span class="status-badge ${efficiency>=80?'status-active':'status-inactive'}">${efficiency}%</span></td><td>${promedio} días</td><td>${report.incidencias_atendidas||0}</td></tr>`;}catch(e){html+=`<tr><td><div class="user-info"><strong>${tech.nombre_completo}</strong><small>${tech.correo}</small></div></td><td>0</td><td>0</td><td>0</td><td><span class="status-badge status-inactive">0%</span></td><td>N/A</td><td>0</td></tr>`;}}
tbody.innerHTML=html||'<tr><td colspan="7">No hay datos disponibles</td></tr>';}catch(error){console.error('Error cargando tabla detallada:',error);document.getElementById('technicianTable').innerHTML='<tr><td colspan="7">Error al cargar datos</td></tr>';}}
async function loadLocationReport(){try{const data=await HttpClient.get('/reporte/ubicacion');console.log('Datos ubicación:',data);if(!data||data.length===0){const ctx=document.getElementById('locationChart').getContext('2d');ctx.fillStyle='#64748b';ctx.font='16px Arial';ctx.textAlign='center';ctx.fillText('Sin datos de ubicación',ctx.canvas.width/2,ctx.canvas.height/2);return;}
const labels=data.map(item=>item.ubicacion?item.ubicacion.substring(0,20):'Sin ubicación');const incidencias=data.map(item=>parseInt(item.total_incidencias)||0);const tareas=data.map(item=>parseInt(item.total_tareas)||0);if(locationChart)locationChart.destroy();const ctx=document.getElementById('locationChart').getContext('2d');locationChart=new Chart(ctx,{type:'bar',data:{labels:labels,datasets:[{label:'Incidencias',data:incidencias,backgroundColor:'#ef4444',borderWidth:1},{label:'Tareas',data:tareas,backgroundColor:'#2563eb',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true,ticks:{stepSize:1}}}}});}catch(error){console.error('Error cargando reporte por ubicación:',error);const ctx=document.getElementById('locationChart').getContext('2d');ctx.fillStyle='#ef4444';ctx.font='16px Arial';ctx.textAlign='center';ctx.fillText('Error al cargar datos',ctx.canvas.width/2,ctx.canvas.height/2);}}
async function loadInventoryReport(){try{const data=await HttpClient.get('/reporte/inventario');console.log('Datos inventario:',data);if(!data||data.length===0){const ctx=document.getElementById('inventoryChart').getContext('2d');ctx.fillStyle='#64748b';ctx.font='16px Arial';ctx.textAlign='center';ctx.fillText('Sin datos de inventario',ctx.canvas.width/2,ctx.canvas.height/2);return;}
const herramientas=data.filter(item=>item.tipo==='herramienta');const materiales=data.filter(item=>item.tipo==='material');const herramientasCount=herramientas.reduce((sum,item)=>sum+(parseInt(item.cantidad_total)||0),0);const materialesCount=materiales.reduce((sum,item)=>sum+(parseInt(item.cantidad_total)||0),0);if(herramientasCount===0&&materialesCount===0){const ctx=document.getElementById('inventoryChart').getContext('2d');ctx.fillStyle='#64748b';ctx.font='16px Arial';ctx.textAlign='center';ctx.fillText('Inventario vacío',ctx.canvas.width/2,ctx.canvas.height/2);return;}
const labels=['Herramientas','Materiales'];const cantidades=[herramientasCount,materialesCount];if(inventoryChart)inventoryChart.destroy();const ctx=document.getElementById('inventoryChart').getContext('2d');inventoryChart=new Chart(ctx,{type:'doughnut',data:{labels:labels,datasets:[{data:cantidades,backgroundColor:['#8b5cf6','#06b6d4'],borderWidth:2,borderColor:'#ffffff'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{usePointStyle:true,padding:15}}}}});}catch(error){console.error('Error cargando reporte de inventario:',error);const ctx=document.getElementById('inventoryChart').getContext('2d');ctx.fillStyle='#ef4444';ctx.font='16px Arial';ctx.textAlign='center';ctx.fillText('Error al cargar datos',ctx.canvas.width/2,ctx.canvas.height/2);}}
async function refreshReports(){ToastManager.info('Actualizando reportes...');try{await loadGeneralReport();await loadTechnicianReport();await loadIncidentTypes();await loadLocationReport();await loadInventoryReport();await loadDetailedTable();ToastManager.success('Reportes actualizados');}catch(error){console.error('Error actualizando reportes:',error);ToastManager.error('Error al actualizar reportes');}}
function exportReport(){const data={general:document.getElementById('generalStats').innerText,timestamp:new Date().toLocaleString('es-CO')};const blob=new Blob([`Reporte IUB - ${data.timestamp}\n\n${data.general}`],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`reporte-iub-${Date.now()}.txt`;a.click();URL.revokeObjectURL(url);ToastManager.success('Reporte exportado');}